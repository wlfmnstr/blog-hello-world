---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';

export async function getStaticPaths() {
  const docsEntries = await getCollection('docs');
  return docsEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Get all docs for sidebar navigation
const allDocs = await getCollection('docs');
const docsByCategory = allDocs.reduce((acc, doc) => {
  const category = doc.data.category;
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(doc);
  return acc;
}, {} as Record<string, typeof allDocs>);

Object.keys(docsByCategory).forEach((category) => {
  docsByCategory[category].sort((a, b) => a.data.order - b.data.order);
});

const categories = Object.keys(docsByCategory).sort();
---

<MainLayout title={entry.data.title} description={entry.data.description}>
  <div class="container mx-auto px-4 py-12">
    <div class="flex gap-8">
      <!-- Sidebar Navigation -->
      <aside class="hidden lg:block w-64 flex-shrink-0">
        <div class="sticky top-20 space-y-6">
          <a
            href="/docs"
            class="inline-flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors mb-4"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <path d="m15 18-6-6 6-6" />
            </svg>
            All Docs
          </a>
          {categories.map((category) => (
            <div>
              <h4 class="font-semibold text-sm mb-2">{category}</h4>
              <ul class="space-y-1">
                {docsByCategory[category].map((doc) => (
                  <li>
                    <a
                      href={`/docs/${doc.slug}`}
                      class={`block px-2 py-1 text-sm rounded transition-colors ${
                        doc.slug === entry.slug
                          ? 'bg-accent text-accent-foreground font-medium'
                          : 'text-muted-foreground hover:text-foreground hover:bg-accent/50'
                      }`}
                    >
                      {doc.data.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </aside>

      <!-- Main Content -->
      <article class="flex-1 max-w-3xl">
        <div class="space-y-2 mb-8">
          <div class="text-sm text-muted-foreground">{entry.data.category}</div>
          <h1 class="text-4xl font-bold">{entry.data.title}</h1>
        </div>

        <div class="prose prose-lg max-w-none">
          <Content />
        </div>
      </article>

      <!-- Table of Contents -->
      {headings.length > 0 && (
        <aside class="hidden xl:block w-64 flex-shrink-0">
          <div class="sticky top-20">
            <h4 class="font-semibold text-sm mb-2">On This Page</h4>
            <ul class="space-y-1 text-sm">
              {headings
                .filter((heading) => heading.depth <= 3)
                .map((heading) => (
                  <li style={{ marginLeft: `${(heading.depth - 1) * 0.75}rem` }}>
                    <a
                      href={`#${heading.slug}`}
                      class="block py-1 text-muted-foreground hover:text-foreground transition-colors"
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
            </ul>
          </div>
        </aside>
      )}
    </div>
  </div>
</MainLayout>
